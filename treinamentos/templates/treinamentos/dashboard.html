{% extends 'base.html' %}
{% load custom_filters %}  <!-- Carregando os filtros personalizados -->

{% block title %}Dashboard de Treinamentos{% endblock %}

{% block content %}

<style>
    .dashboard-container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }

    .dashboard-title {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    .charts-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
    }

    .chart-box {
        background: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        width: 250px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .status-vencidos { color: #dc3545; }
    .status-urgência { color: #ffc107; }
    .status-atenção { color: #007bff; }
    .status-válidos { color: #28a745; }
    .status-sem-validade { color: #6c757d; }

</style>

<div class="dashboard-container">
    <h2 class="dashboard-title">Dashboard de Treinamentos</h2>

    <div class="charts-container">
        {% for status, color, count in [
            ("Vencidos", "#dc3545", vencidos),
            ("Urgência", "#ffc107", alerta),
            ("Atenção", "#007bff", atencao),
            ("Válidos", "#28a745", ok),
            ("Sem Validade", "#6c757d", sem_validade)
        ] %}
        <div class="chart-box">
            <div class="chart-title status-{{ status|lower|replace:' ' '-' }}">{{ status }}</div>
            <canvas id="chart-{{ status|lower|replace:' ' '-' }}"></canvas>
            <p class="status-{{ status|lower|replace:' ' '-' }}">
                <strong>{{ count }}</strong> treinamentos {{ status|lower }}
            </p>
        </div>
        {% endfor %}
    </div>

    <h3 class="dashboard-title">Treinamentos Cadastrados</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Funcionário</th>
                <th>Treinamento</th>
                <th>Norma</th>
                <th>Validade</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for treinamento in treinamentos %}
            <tr>
                <td>{{ treinamento.funcionario }}</td>
                <td>{{ treinamento.nome_treinamento }}</td>
                <td>{{ treinamento.norma }}</td>
                <td>{{ treinamento.validade_passaporte|default:"Sem validade" }}</td>
                <td class="status-{{ treinamento.calcular_status.1 }}">{{ treinamento.calcular_status.0 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const statusData = {
        "Vencidos": {{ vencidos }},
        "Urgência": {{ alerta }},
        "Atenção": {{ atencao }},
        "Válidos": {{ ok }},
        "Sem Validade": {{ sem_validade }},
        "Total": {{ total_treinamentos }}
    };

    const statusColors = {
        "Vencidos": "#dc3545",
        "Urgência": "#ffc107",
        "Atenção": "#007bff",
        "Válidos": "#28a745",
        "Sem Validade": "#6c757d",
        "Total": "#000000"
    };

    document.addEventListener("DOMContentLoaded", function () {
        for (const [status, count] of Object.entries(statusData)) {
            if (document.getElementById(`chart-${status.toLowerCase().replace(' ', '-')}`)) {
                new Chart(document.getElementById(`chart-${status.toLowerCase().replace(' ', '-')}`), {
                    type: "doughnut",
                    data: {
                        labels: [status, "Outros"],
                        datasets: [{
                            data: [count, statusData["Total"] - count],
                            backgroundColor: [statusColors[status], "#000000"]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
    });
</script>

{% endblock %}