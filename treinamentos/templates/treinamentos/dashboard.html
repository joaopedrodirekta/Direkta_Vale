{% extends 'base.html' %}
{% load custom_filters %}  {# Carregar os filtros personalizados #}

{% block title %}Dashboard de Treinamentos{% endblock %}

{% block content %}

<style>
    .dashboard-container {
        max-width: 1100px;
        margin: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }

    .dashboard-title {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    .charts-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
    }

    .chart-box {
        width: 250px;
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        text-align: center;
    }

    .chart-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .status-vermelho { color: #dc3545; }
    .status-amarelo { color: #ffc107; }
    .status-azul { color: #007bff; }
    .status-verde { color: #28a745; }
    .status-cinza { color: #6c757d; }
</style>

<div class="dashboard-container">
    <h2 class="dashboard-title">Dashboard de Treinamentos</h2>

    <div class="charts-container">
        {% for status, color, count in [
            ("Vencidos", "#dc3545", vencidos),
            ("Urgência", "#ffc107", alerta),
            ("Atenção", "#007bff", atencao),
            ("Válidos", "#28a745", ok),
            ("Sem Validade", "#6c757d", sem_validade)
        ] %}
        <div class="chart-box">
            <div class="chart-title status-{{ status|lower|replace:' ' '-' }}">{{ status }}</div>
            <canvas id="chart-{{ status|lower|replace:' ' '-' }}"></canvas>
            <p class="status-{{ status|lower|replace:' ' '-' }}">
                <strong>{{ count }}</strong> treinamentos {{ status|lower }}
            </p>
        </div>
        {% endfor %}
    </div>

    <h3 class="dashboard-title">Treinamentos Cadastrados</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Funcionário</th>
                <th>Treinamento</th>
                <th>Data Inicial</th>
                <th>Data Final</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for treinamento in treinamentos %}
            <tr>
                <td>{{ treinamento.funcionario.nome_completo }}</td>
                <td>{{ treinamento.nome_treinamento }}</td>
                <td>{{ treinamento.data_inicio|default:"-" }}</td>
                <td>{{ treinamento.data_fim|default:"-" }}</td>
                <td class="status-{{ treinamento.calcular_status.1 }}">
                    {{ treinamento.calcular_status.0 }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">Nenhum treinamento cadastrado</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const statusData = {
        vencidos: {{ vencidos }},
        alerta: {{ alerta }},
        atencao: {{ atencao }},
        ok: {{ ok }},
        semValidade: {{ sem_validade }},
        total: {{ total_treinamentos }}
    };

    const colors = {
        "Vencidos": "#dc3545",
        "Urgência": "#ffc107",
        "Atenção": "#007bff",
        "Válidos": "#28a745",
        "Sem Validade": "#6c757d"
    };

    const statuses = ["Vencidos", "Urgência", "Atenção", "Válidos", "Sem Validade"];

    statuses.forEach(status => {
        const id = status.toLowerCase().replace(/ /g, "-");
        new Chart(document.getElementById("chart-" + id), {
            type: "doughnut",
            data: {
                labels: [status, "Total"],
                datasets: [{
                    data: [statusData[id], statusData.total - statusData[id]],
                    backgroundColor: [colors[status], "#000000"]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) {
                                return tooltipItem.raw + " treinamentos";
                            }
                        }
                    }
                }
            }
        });
    });
</script>

{% endblock %}