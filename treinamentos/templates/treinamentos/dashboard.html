{% extends 'base.html' %}
{% block title %}Dashboard de Treinamentos{% endblock %}

{% block content %}

<style>
    .dashboard-container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }

    .dashboard-title {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }

    .charts-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .chart-box {
        width: 48%;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .status-vencidos { color: #dc3545; }
    .status-alerta { color: #ffc107; }
    .status-atencao { color: #007bff; }
    .status-ok { color: #28a745; }
    .status-sem-validade { color: #6c757d; }

    .btn-export {
        margin-top: 20px;
    }
</style>

<div class="dashboard-container">
    <h2 class="dashboard-title">Dashboard de Treinamentos</h2>

    <div class="charts-container">
        {% for status, color, count in [
            ("Vencidos", "#dc3545", vencidos),
            ("Urgência", "#ffc107", alerta),
            ("Atenção", "#007bff", atencao),
            ("Válidos", "#28a745", ok),
            ("Sem Validade", "#6c757d", sem_validade)
        ] %}
        <div class="chart-box">
            <div class="chart-title status-{{ status|lower|replace(' ', '-') }}">{{ status }}</div>
            <canvas id="chart-{{ status|lower|replace(' ', '-') }}"></canvas>
            <p class="status-{{ status|lower|replace(' ', '-') }}"><strong>{{ count }}</strong> treinamentos {{ status|lower }}</p>
        </div>
        {% endfor %}
    </div>

    <h3 class="dashboard-title">Treinamentos Cadastrados</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Funcionário</th>
                <th>Treinamento</th>
                <th>Data Inicial</th>
                <th>Data Final</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for treinamento in treinamentos %}
            <tr>
                <td>{{ treinamento.funcionario.nome_completo }}</td>
                <td>{{ treinamento.nome_treinamento }}</td>
                <td>{{ treinamento.data_inicio }}</td>
                <td>{{ treinamento.data_fim }}</td>
                <td class="status-{{ treinamento.calcular_status.1 }}">{{ treinamento.calcular_status.0 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button class="btn btn-primary btn-export" onclick="window.print()">Imprimir Relatório</button>
    <button class="btn btn-success btn-export" onclick="exportToExcel()">Exportar para Excel</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function createChart(id, count, color) {
        new Chart(document.getElementById(id), {
            type: "doughnut",
            data: {
                labels: ["{{ status }}", "Total"],
                datasets: [{
                    data: [count, {{ total_treinamentos }} - count],
                    backgroundColor: [color, "#000"]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                }
            }
        });
    }

    createChart("chart-vencidos", {{ vencidos }}, "#dc3545");
    createChart("chart-urgencia", {{ alerta }}, "#ffc107");
    createChart("chart-atencao", {{ atencao }}, "#007bff");
    createChart("chart-validos", {{ ok }}, "#28a745");
    createChart("chart-sem-validade", {{ sem_validade }}, "#6c757d");

    function exportToExcel() {
        let table = document.querySelector(".table");
        let wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, "Treinamentos.xlsx");
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

{% endblock %}